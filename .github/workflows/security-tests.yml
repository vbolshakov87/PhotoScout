name: LLM Security Tests (Promptfoo)

# ==============================================================================
# MANUAL ONLY - This workflow uses paid API keys (OpenAI, Anthropic, etc.)
# Trigger manually from Actions tab when needed.
# ==============================================================================

on:
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Filter pattern (e.g., CRITICAL, prompt_injection, or empty for all)'
        required: false
        default: 'CRITICAL'
      model_set:
        description: 'Model set to test'
        required: false
        default: 'prod'
        type: choice
        options:
          - prod # Claude Sonnet 4 only (~$0.11)
          - default # 6 models (~$0.50)
          - all # 8 models (~$0.88)

env:
  NODE_VERSION: '20'

jobs:
  llm-security-tests:
    name: LLM Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Promptfoo config
        working-directory: packages/api
        run: |
          MODEL_SET="${{ github.event.inputs.model_set || 'prod' }}"
          echo "ðŸ¤– Model set: $MODEL_SET"

          case "$MODEL_SET" in
            prod)
              pnpm security:convert -- --prod
              ;;
            all)
              pnpm security:convert -- --all
              ;;
            *)
              pnpm security:convert
              ;;
          esac

      - name: Run Security Tests
        working-directory: packages/api
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
        run: |
          FILTER="${{ github.event.inputs.test_filter }}"

          if [ -n "$FILTER" ]; then
            echo "ðŸ” Running tests with filter: $FILTER"
            npx promptfoo eval --filter-description "$FILTER" --output results.json --no-cache
          else
            echo "ðŸ” Running full test suite"
            npx promptfoo eval --output results.json --no-cache
          fi

      - name: Check Results
        working-directory: packages/api
        run: |
          if [ -f results.json ]; then
            FAILURES=$(cat results.json | jq '.results.stats.failures // 0')
            TOTAL=$(cat results.json | jq '.results.stats.successes + .results.stats.failures')

            if [ "$TOTAL" -gt 0 ]; then
              PASS_RATE=$(echo "scale=1; (($TOTAL - $FAILURES) / $TOTAL) * 100" | bc)
            else
              PASS_RATE="0"
            fi

            echo "## LLM Security Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
            echo "- Model set: \`${{ github.event.inputs.model_set }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Filter: \`${{ github.event.inputs.test_filter || 'none (full suite)' }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Results:**" >> $GITHUB_STEP_SUMMARY
            echo "- Total Tests: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- Passed: $(($TOTAL - $FAILURES))" >> $GITHUB_STEP_SUMMARY
            echo "- Failed: $FAILURES" >> $GITHUB_STEP_SUMMARY
            echo "- Pass Rate: ${PASS_RATE}%" >> $GITHUB_STEP_SUMMARY

            if [ "$FAILURES" -gt "0" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo ":warning: **$FAILURES security test(s) failed!**" >> $GITHUB_STEP_SUMMARY
              echo "::warning::$FAILURES security test(s) failed"
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo ":white_check_mark: All security tests passed!" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: security-test-results
          path: packages/api/results.json
          retention-days: 30
